<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>TON Roulette Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        :root { --tg-bg: #0a0a0c; --blue: #0088cc; --glass: rgba(255, 255, 255, 0.08); }
        body { font-family: -apple-system, sans-serif; background: var(--tg-bg); color: white; margin: 0; overflow: hidden; }
        .page { display: none; height: 100vh; padding-bottom: 80px; overflow-y: auto; }
        .active { display: flex; flex-direction: column; }
        .top-nav { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); }
        .wallet-chip { background: var(--glass); padding: 10px 15px; border-radius: 15px; border: 1px solid var(--blue); display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .balance-main { font-size: 42px; font-weight: 900; color: var(--blue); text-align: center; margin: 20px 0; }
        .profile-card { background: var(--glass); border-radius: 18px; padding: 15px; text-align: center; border: 1px solid #222; }
        .profile-card b { display: block; font-size: 20px; color: var(--blue); }
        .inv-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .inv-item { background: var(--glass); border-radius: 15px; padding: 10px; text-align: center; position: relative; border: 1px solid #333; }
        .stake-badge { position: absolute; top: 5px; right: 5px; background: #00ff00; color: #000; font-size: 9px; padding: 2px 5px; border-radius: 5px; font-weight: bold; }
        .nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: #111; display: flex; border-top: 1px solid #222; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: #555; cursor: pointer; }
        .nav-btn.active { color: var(--blue); }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:1000; padding:20px; flex-direction: column; justify-content: center; }
        .buy-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .buy-btn { background: var(--glass); border: 1px solid var(--blue); color: white; padding: 15px; border-radius: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="game-page" class="page active">
        <div class="top-nav">
            <div id="ton-connect"></div>
            <div class="wallet-chip" onclick="openModal('buy-modal')">
                <span id="bal-header">0.00</span> TON
                <b style="color:var(--blue); font-size: 20px;">+</b>
            </div>
        </div>
        
        <div class="balance-main" id="bank-display">0.00 TON</div>
        <p style="text-align: center; color: #555; margin-top: -20px;">В БАНКЕ</p>

        <div style="padding: 15px; display: flex; gap: 10px;">
            <input type="number" id="bet-input" value="1" step="0.1" style="flex: 1; background: #111; border: 1px solid #333; color: white; padding: 15px; border-radius: 15px;">
            <button onclick="makeBet()" style="background: var(--blue); border: none; color: white; padding: 0 30px; border-radius: 15px; font-weight: bold;">СТАВКА</button>
        </div>

        <div id="players-list" style="padding: 15px;"></div>
    </div>

    <div id="profile-page" class="page">
        <div style="padding: 30px; text-align: center;">
            <div id="user-addr" style="font-size: 12px; color: var(--blue); margin-bottom: 20px;">Подключите кошелек...</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="profile-card"><b id="p-bal">0.00</b>Баланс TON</div>
                <div class="profile-card"><b id="p-daily" style="color:#00ff00">+0.00</b>В день</div>
                <div class="profile-card"><b id="p-staked">0.00</b>Нафармлено</div>
                <div class="profile-card"><b>-</b>Рейтинг</div>
            </div>
            <button onclick="switchTab('inventory')" style="width:100%; margin-top:20px; padding:18px; background:var(--glass); border:1px solid #333; color:white; border-radius:15px; font-weight: bold;">МОЙ ИНВЕНТАРЬ</button>
        </div>
    </div>

    <div id="inventory-page" class="page">
        <h2 style="text-align: center;">Инвентарь</h2>
        <div id="inv-list" class="inv-grid"></div>
        <button onclick="switchTab('profile')" style="margin: 20px; color: #555; border: none; background: none;">← Назад</button>
    </div>

    <div id="buy-modal" class="modal">
        <h2 style="text-align: center;">Купить TON за Звезды</h2>
        <p style="text-align: center; color: #666; font-size: 12px; margin-bottom: 20px;">Курс как на Fragment</p>
        <div class="buy-grid">
            <button class="buy-btn" onclick="pay(50)">1.25 TON<br><small>50 ⭐</small></button>
            <button class="buy-btn" onclick="pay(100)">2.50 TON<br><small>100 ⭐</small></button>
            <button class="buy-btn" onclick="pay(250)">6.25 TON<br><small>250 ⭐</small></button>
            <button class="buy-btn" onclick="pay(500)">12.50 TON<br><small>500 ⭐</small></button>
            <button class="buy-btn" onclick="pay(1000)">25.00 TON<br><small>1000 ⭐</small></button>
            <button class="buy-btn" onclick="pay(2500)">62.50 TON<br><small>2500 ⭐</small></button>
        </div>
        <button onclick="closeModal('buy-modal')" style="margin-top: 30px; color: #555; border: none; background: none; cursor: pointer;">Закрыть</button>
    </div>

    <div class="nav">
        <div class="nav-btn active" onclick="switchTab('game', this)"><span>ИГРА</span></div>
        <div class="nav-btn" onclick="switchTab('profile', this)"><span>ПРОФИЛЬ</span></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const socket = io();
        tg.expand();

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://raw.githubusercontent.com/ton-community/tutorials/main/03-client/unprotected/public/tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });

        tonConnectUI.onStatusChange(wallet => {
            if (wallet) {
                const addr = wallet.account.address;
                document.getElementById('user-addr').innerText = addr.substring(0,8) + '...' + addr.substring(addr.length-6);
                socket.emit('auth', { wallet: addr, tgId: tg.initDataUnsafe.user?.id, username: tg.initDataUnsafe.user?.first_name });
            }
        });

        socket.on('updateUserData', (data) => {
            const b = data.balance.toFixed(2);
            document.getElementById('bal-header').innerText = b;
            document.getElementById('p-bal').innerText = b;
            document.getElementById('p-staked').innerText = data.totalStakedIncome.toFixed(4);

            let daily = 0;
            data.inventory.forEach(i => { if(i.isStaked) daily += i.price * 0.001 });
            document.getElementById('p-daily').innerText = "+" + daily.toFixed(4);

            const list = document.getElementById('inv-list');
            list.innerHTML = data.inventory.map(item => `
                <div class="inv-item">
                    ${item.isStaked ? '<span class="stake-badge">ФАРМИНГ</span>' : ''}
                    <img src="${item.image}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px;">
                    <div style="font-size: 12px; margin: 5px 0; font-weight: bold;">${item.name}</div>
                    <button onclick="socket.emit('toggleStake', '${item.itemId}')" style="width:100%; border:none; padding:8px; border-radius:10px; background:${item.isStaked ? '#ff3b30' : '#007bff'}; color:white; font-size:10px; cursor: pointer; font-weight: bold;">
                        ${item.isStaked ? 'СНЯТЬ' : 'СТЕЙКИНГ'}
                    </button>
                </div>
            `).join('');
        });

        socket.on('sync', (data) => {
            document.getElementById('bank-display').innerText = data.bank.toFixed(2) + " TON";
        });

        function switchTab(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id + '-page').classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
            }
        }

        function pay(stars) { socket.emit('createInvoice', stars); }
        socket.on('invoiceLink', (d) => tg.openInvoice(d.url));
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function makeBet() {
            const betInput = document.getElementById('bet-input');
            const bet = parseFloat(betInput.value);
            if (bet > 0) {
                socket.emit('makeBet', { bet, photo: tg.initDataUnsafe.user?.photo_url });
            }
        }
    </script>
</body>
</html>
